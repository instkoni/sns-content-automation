# Genspark Automation 設計書

## 概要

Genspark の画像生成エージェントを使用して、NOTE記事用のインフォグラフィックを自動生成するツール。

## システム構成

```
instkoni-automation/
├── genspark_automation.ts    # メインスクリプト
├── browser-data/             # ブラウザセッションデータ（ログイン状態保持）
└── docs/
    ├── genspark_automation_design.md   # 本設計書
    └── genspark_automation_manual.md   # 運用マニュアル

articles/
├── drafts/                   # 入力: 下書き記事 (.md)
├── published/                # 公開済み記事
└── infographic/              # 出力: 生成画像
    ├── last_prompt.txt       # 最後に使用したプロンプト
    ├── debug_*.png           # デバッグ用スクリーンショット
    └── YYYYMMDDHHMMSS_記事名/  # 生成画像フォルダ
        └── *.png
```

## 技術スタック

| 項目 | 技術 |
|------|------|
| 言語 | TypeScript |
| ランタイム | Node.js + ts-node |
| ブラウザ自動化 | Playwright (Chromium) |
| 対象サービス | Genspark (https://www.genspark.ai) |

## 処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 記事取得                                                      │
│    articles/drafts/ から最新の .md ファイルを取得                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 2. プロンプト生成                                                │
│    記事内容 + インフォグラフィック指示を結合                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 3. ブラウザ起動                                                  │
│    Playwright で Chromium を起動（セッション永続化）             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 4. Genspark 画像生成ページへ移動                                 │
│    https://www.genspark.ai/agents?type=image_generation_agent   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 5. GUI設定                                                       │
│    - 「設定」ボタンをクリック                                    │
│    - 解像度: 2K を選択                                           │
│    - アスペクト比: 16:9 を選択                                   │
│    - 設定パネルを閉じる (Escape)                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 6. プロンプト入力・送信                                          │
│    - textarea にプロンプトを入力                                 │
│    - Enter キーで送信                                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 7. 画像生成待機（自動検出）                                      │
│    - 5秒間隔で大きな画像 (200x200以上) を検出                    │
│    - 3回連続で同じ画像数 → 生成完了と判定                        │
│    - 最大10分待機                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 8. 画像ダウンロード                                              │
│    各画像に対して:                                               │
│    - 画像をクリック → 詳細ビューを開く                          │
│    - 右下のダウンロードボタンをクリック                          │
│    - ダウンロードイベントを待機・保存                            │
│    - Escape で閉じて次の画像へ                                   │
│    ※ 失敗時はスクリーンショットでフォールバック                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 9. 完了                                                          │
│    - 保存ファイル一覧を表示                                      │
│    - ブラウザを閉じる                                            │
└─────────────────────────────────────────────────────────────────┘
```

## 主要関数

| 関数名 | 説明 |
|--------|------|
| `getLatestDraftArticle()` | `articles/drafts/` から最新の .md ファイルを取得 |
| `extractArticleName(filename)` | ファイル名から記事名を抽出（日付・拡張子除去） |
| `generateTimestamp()` | YYYYMMDDHHMMSS 形式のタイムスタンプ生成 |
| `downloadImage(url, filepath)` | URL から画像をダウンロード（HTTP/HTTPS対応） |
| `generateImages()` | メイン処理：画像生成の全フロー |
| `main()` | エントリーポイント：コマンド引数の処理 |

## 設定値

| 設定 | 値 | 説明 |
|------|-----|------|
| `GENSPARK_IMAGE_URL` | `https://www.genspark.ai/agents?type=image_generation_agent` | 画像生成エージェントURL |
| `USER_DATA_DIR` | `./browser-data` | ブラウザセッション保存先 |
| `maxWaitTime` | 10分 | 画像生成の最大待機時間 |
| `checkInterval` | 5秒 | 画像検出のチェック間隔 |
| `stableCount` | 3回 | 完了判定に必要な安定回数（15秒） |

## プロンプトテンプレート

```
このNOTE記事にインフォグラフィックを入れたい。
・記事を分析し、適切な数のインフォグラフィックを作成して欲しい。
・中項目レベルで１つずつ
・グラフィックレコーディング風の手描き図解にしてください。
・重要なキーワードやコンセプトを視覚的に表現し、親しみやすいイラストと手書き風のフォントでまとめてください。

[記事本文]
```

## 出力仕様

### 保存先
```
articles/infographic/YYYYMMDDHHMMSS_記事名/
```

### ファイル命名規則
```
YYYYMMDDHHMMSS_記事名_01.png
YYYYMMDDHHMMSS_記事名_02.png
...
```

## 制限事項・注意点

1. **ログイン必須**: 初回実行時は手動でGensparkにログインが必要
2. **Genspark側の制限**: 生成中にフリーズする場合がある
3. **画像検出精度**: 200x200px以上の画像を対象（アイコン等は除外）
4. **セッション管理**: `browser-data/` を削除するとログイン状態がリセットされる

## 今後の改善案

- [ ] 生成完了の判定精度向上（ローディングインジケーター検出）
- [ ] 複数記事の一括処理
- [ ] 生成画像の品質チェック機能
- [ ] エラー時のリトライ機能
